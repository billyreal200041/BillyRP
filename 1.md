ALLINX 生产环境 · 业务数据流转拓扑图（README）

最后更新：2025-09-14（Asia/Kuala_Lumpur）
依据：kubectl get pod/svc（landry/morph/moth），以及已知 APISIX/CloudFront/ALB 路由策略（本仓库文档）。
目标：自“域名入口 → 负载均衡 → 网关 → 业务服务 → 数据层”的端到端视图，并列出全部服务清单和端口暴露方式。

1) 自顶向下流量路径（总览）

为保证在 GitHub 上 100% 可渲染，主图不带边标签；域名→路径→服务的映射见第 2 节。

flowchart LR
  U[用户] --> DNS[DNS/域名]
  DNS --> CF[CloudFront/CDN]

  subgraph LB[入口负载均衡]
    ALB_PUB[ALB public]
    ALB_INT[ALB internal]
    NLB_AWF[awf-spa-nlb (NLB)]
  end

  CF --> ALB_PUB
  DNS --> ALB_INT
  CF --> NLB_AWF

  APISIX[APISIX Gateway]
  ALB_PUB --> APISIX
  ALB_INT --> APISIX

  subgraph Landry[现货域 · landry]
    SPOTAPI[spotapi-web]
    SPOTWS[spotws-web]
    USERSVR[userserver-web]
    BROKER[brokerserver-web]
    MACK_SPA[mackerel-spa]
    ANEMONE[anemone-web]
    CES_ACCESS[ces-accesshttp]
    CES_OTHERS[ces-* 组件]
  end

  subgraph Morph[合约域 · morph]
    AWF_SPA[awf-spa]
    FUT_WEB[futuresweb-web]
    FUT_OPEN[futuresopen-web]
    FUT_WS[futuresws-app]
    FUT_ADMIN[futuresadmin-web]
    FUT_MARKET[futuresmarket-app]
    NARW_ACC[narwhal-accesshttp]
    NARW_OTHERS[narwhal-* 组件]
  end

  subgraph Moth[NEXS · moth]
    NEXS_GW[nexs-gateway]
    NEXS_MKT[nexs-market]
    NEXS_TRD[nexs-trade]
    NEXS_UC[nexs-usercenter]
  end

  APISIX --> Landry
  APISIX --> Morph
  APISIX --> Moth
  NLB_AWF --> AWF_SPA

  subgraph DATA[数据层/中间件]
    SPOTDB[(spotdb.aie.prod / RDS)]
    SPOTREDIS[(spotredis.aie.prod / Redis)]
    KAFKA[(kafka.aie.prod:9092)]

    FUTDB[(futuresnewdb.aie.prod / RDS)]
    FUTREDIS[(futuresnewredis.aie.prod / Redis)]
    KAFKANEW[(kafkanew.aie.prod:9092)]
    ETCDNEW[(etcdnew.aie.prod:2379)]
  end

  SPOTAPI --> SPOTDB
  SPOTAPI --> SPOTREDIS
  SPOTAPI --> KAFKA
  SPOTWS --> SPOTREDIS

  FUT_WEB --> FUTDB
  FUT_WEB --> FUTREDIS
  FUT_OPEN --> FUTDB
  FUT_WS --> FUTREDIS
  FUT_ADMIN --> FUTDB
  NARW_ACC --> ETCDNEW
  NARW_ACC --> KAFKANEW

  NEXS_GW --> FUTDB
  NEXS_MKT --> FUTDB
  NEXS_TRD --> FUTDB
  NEXS_UC --> FUTDB

2) 域名 → 上游服务映射（生产）

下表用于“入口层与上游服务”的速查。域名和路径来自现有文档与网关配置习惯，若需 100% 校准，请配合 APISIX Admin 导出（routes/services/upstreams）。

域名 (Host)	路径 (Path)	命名空间/服务 (Service:Port)
www.allinpro.com	/*	morph/morph-awf-spa:8080
api.allinpro.com	/*	landry/landry-spotapi-web:8080
api.allinpro.com	/futures/web/api/*	morph/morph-futuresweb-web:8080
api.allinpro.com	/futuresopen/*	morph/morph-futuresopen-web:8080
api.allinpro.com	/futures/ws*	morph/morph-futuresws-app:8080
api.allinpro.com	/moth-nexs-gateway/*	moth/moth-nexs-gateway:8080
user.allinpro.com	/*	landry/landry-userserver-web:8080
ws.allinpro.com	/ws*	landry/landry-spotws-web:8080
brokerserver.allinpro.com	/*	landry/landry-brokerserver-web:8080
mackerel.aie.prod	/api/*	landry/landry-anemone-web:8080
mackerel.aie.prod 或 mackerel.allinpro.com	/*	landry/landry-mackerel-spa:8080
*.aie.prod（内部）	/*	morph/morph-narwhal-accesshttp:8080 等内部服务

AWF 静态站点的备用直连路径（NLB）
morph 命名空间存在 awf-spa-nlb (LoadBalancer) 指向 morph-awf-spa:8080，有可能作为 CloudFront 的某些 Origin：

flowchart LR
  U[用户] --> CF[CloudFront]
  CF --> ALB[apisix-public (ALB)] --> APISIX[APISIX] --> AWF[morph-awf-spa:8080]
  CF --> NLB[awf-spa-nlb (80/443)] --> AWF

3) 服务清单（生产 · 全量）

以下按命名空间列出当前所有 Pod（来自你贴出的 kubectl get pod），并给出 Service 端口/暴露方式（来自 kubectl get svc -o wide）。若某 Pod 无对外端口，可能仅通过集群内通信或消息中间件参与链路。

3.1 · landry（现货域）

Pods

landry-anemone-web（8080）

landry-apa-spa（8080）

landry-awftest-spa（8080）

landry-brokercron-*（一组定时任务：daily-report / rebate / daily-settlement / snap-user-balance / stat-user-trade / sync-xxx）

landry-brokerserver-web（8080）

landry-ces-accesshttp（8080）

landry-ces-cachecenter（7810/7802/7803…）

landry-ces-historyreader（7516）

landry-ces-historywriter（无端口，链路内用）

landry-ces-marketprice（7416）

landry-ces-matchengine（7316）

landry-ces-monitorcenter（5555）

landry-ces-tradesummary（7519）

landry-clairvoy-web（8080/9000）

landry-cobocb-web（8080）

landry-cobogw-web（8080）

landry-gateway-web（8080）

landry-mackerel-spa（8080）

landry-spotapi-web（8080）

landry-spottask-web（8080）

landry-spotws-web（8080）

landry-tgsggd-bot（定时/机器人）

landry-trans-web（8080/9000）

landry-userserver-web（8080）

Services（来自 kubectl get svc -n landry -o wide）

Service	Type	ClusterIP	Ports (→NodePort)
landry-anemone-web	ClusterIP	172.20.21.136	8080
landry-apa-spa	ClusterIP	172.20.2.42	8080
landry-awftest-spa	ClusterIP	172.20.247.6	8080
landry-brokerserver-web	NodePort	172.20.169.156	8080 → 30864
landry-ces-accesshttp	ClusterIP	172.20.118.119	8080
landry-ces-cachecenter	ClusterIP	172.20.26.118	7810, 7811, 7812, 7813, 7802, 7803
landry-ces-historyreader	ClusterIP	172.20.131.200	7516
landry-ces-marketprice	ClusterIP	172.20.250.131	7416
landry-ces-matchengine	ClusterIP	172.20.123.252	7316
landry-ces-monitorcenter	ClusterIP	172.20.240.167	5555
landry-ces-tradesummary	ClusterIP	172.20.12.52	7519
landry-clairvoy-web	NodePort	172.20.130.89	8080 → 30906, 9000 → 31816
landry-cobocb-web	ClusterIP	172.20.130.39	8080
landry-cobogw-web	ClusterIP	172.20.242.96	8080
landry-gateway-web	ClusterIP	172.20.150.146	8080
landry-mackerel-spa	ClusterIP	172.20.139.47	8080
landry-spotapi-web	ClusterIP	172.20.159.111	8080
landry-spottask-web	ClusterIP	172.20.168.40	8080
landry-spotws-web	ClusterIP	172.20.7.15	8080
landry-trans-web	NodePort	172.20.49.204	8080 → 31603, 9000 → 31562
landry-userserver-web	ClusterIP	172.20.67.107	8080
3.2 · morph（合约域）

Pods

ingress-nginx-controller（80/443/8443）

morph-awf-spa、morph-awftest-spa（8080）

morph-cond-web（8080）

morph-futuresadmin-web（8080）

morph-futuresmarket-app（8080）

morph-futuresopen-web（8080）

morph-futuresschedule-app（8080）

morph-futuresweb-web（8080）

morph-futuresws-app（8080）

morph-narwhal-* 组件（accesshttp / alertcenter / cachecenter / historyreader / historywriter / marketindex / marketprice / matchengine / monitorcenter / operlogcompact / tradesummary），主容器端口与监控 sidecar（8888）如 get deploy 所示

Services（来自 kubectl get svc -n morph -o wide）

Service	Type	ClusterIP	External	Ports
awf-spa-nlb	LoadBalancer (NLB)	172.20.222.54	*.elb.ap-southeast-1.amazonaws.com	80, 443
ingress-nginx-controller	ClusterIP	172.20.114.16	—	80, 443
ingress-nginx-controller-admission	ClusterIP	172.20.23.159	—	443
morph-awf-spa	ClusterIP	172.20.3.34	—	8080
morph-awftest-spa	ClusterIP	172.20.86.95	—	8080
morph-cond-web	ClusterIP	172.20.227.125	—	8080
morph-futuresadmin-web	ClusterIP	172.20.5.108	—	8080
morph-futuresmarket-app	ClusterIP	172.20.220.215	—	8080
morph-futuresopen-web	ClusterIP	172.20.129.63	—	8080
morph-futuresschedule-app	ClusterIP	172.20.217.62	—	8080
morph-futuresweb-web	ClusterIP	172.20.105.94	—	8080
morph-futuresws-app	ClusterIP	172.20.249.255	—	8080
morph-narwhal-accesshttp	ClusterIP	172.20.88.111	—	8080
morph-narwhal-alertcenter	ClusterIP	172.20.178.192	—	4444
morph-narwhal-cachecenter	ClusterIP	172.20.93.111	—	7810, 7802, 7803
morph-narwhal-historyreader	ClusterIP	172.20.151.178	—	7516
morph-narwhal-marketindex	ClusterIP	172.20.76.67	—	7901
morph-narwhal-marketprice	ClusterIP	172.20.59.159	—	7416
morph-narwhal-matchengine	ClusterIP	172.20.21.58	—	7316, 8316
morph-narwhal-monitorcenter	ClusterIP	172.20.204.222	—	5555
morph-narwhal-tradesummary	ClusterIP	172.20.36.7	—	7519
morph-sub-web	ClusterIP	172.20.77.134	—	8080
3.3 · moth（NEXS）

Pods

moth-nexs-gateway（8080）

moth-nexs-market（9090）

moth-nexs-trade（9090）

moth-nexs-usercenter（9090）

Services（来自 kubectl get svc -n moth -o wide）

Service	Type	ClusterIP	Ports
moth-nexs-gateway	ClusterIP	172.20.21.60	8080
moth-nexs-market	ClusterIP	172.20.70.196	9090
moth-nexs-trade	ClusterIP	172.20.17.52	9090
moth-nexs-usercenter	ClusterIP	172.20.32.1	9090
4) 细粒度数据流子图
4.1 · 现货 CES 子图
flowchart LR
  SPOTAPI[landry-spotapi-web]
  SPOTWS[landry-spotws-web]
  ACCESS[ces-accesshttp]
  MATCH[ces-matchengine]
  MKT[ces-marketprice]
  HISTW[ces-historywriter]
  HISTR[ces-historyreader]
  CACHE[ces-cachecenter]
  MON[ces-monitorcenter]
  SUM[ces-tradesummary]
  SPOTDB[(spotdb)]
  SPOTREDIS[(spotredis)]
  KAFKA[(kafka)]

  SPOTAPI --> ACCESS
  SPOTAPI --> SPOTDB
  SPOTAPI --> SPOTREDIS
  SPOTAPI --> KAFKA
  SPOTWS --> SPOTREDIS
  ACCESS --> MATCH
  ACCESS --> MKT
  ACCESS --> HISTW
  HISTW --> HISTR
  ACCESS --> CACHE
  ACCESS --> MON
  ACCESS --> SUM

4.2 · 合约 Narwhal 子图
flowchart LR
  ACCESS[narwhal-accesshttp]
  MATCH[narwhal-matchengine]
  MKT[narwhal-marketprice]
  IDX[narwhal-marketindex]
  HISTW[narwhal-historywriter]
  HISTR[narwhal-historyreader]
  CACHE[narwhal-cachecenter]
  MON[narwhal-monitorcenter]
  SUM[narwhal-tradesummary]

  FUTDB[(futuresnewdb)]
  FUTREDIS[(futuresnewredis)]
  KAFKANEW[(kafkanew:9092)]
  ETCDNEW[(etcdnew:2379)]

  ACCESS --> MATCH
  ACCESS --> MKT
  ACCESS --> IDX
  ACCESS --> HISTW
  HISTW --> HISTR
  ACCESS --> CACHE
  ACCESS --> MON
  ACCESS --> SUM

  MATCH --> FUTDB
  MATCH --> FUTREDIS
  MKT --> FUTDB
  HISTW --> FUTDB
  SUM --> FUTDB
  ACCESS --> ETCDNEW
  ACCESS --> KAFKANEW

5) 数据层与中间件（生产）

Landry（现货）

RDS：spotdb.aie.prod

Redis：spotredis.aie.prod

Kafka：kafka.aie.prod:9092

Morph（合约）

RDS：futuresnewdb.aie.prod

Redis：futuresnewredis.aie.prod

Kafka：kafkanew.aie.prod:9092（EC2 自建）

Etcd：etcdnew.aie.prod:2379

6) 入口形态与暴露策略

外网：域名 → CloudFront (TLS) → ALB → APISIX → ClusterIP Service

内网：*.aie.prod → 内部 ALB → APISIX → ClusterIP Service

morph 侧存在 awf-spa-nlb（NLB，80/443）可能由 CloudFront 直接回源。

少量 NodePort（如 landry-brokerserver-web/landry-clairvoy-web/landry-trans-web）建议限制在内网或白名单。

7) 可验证命令（可选，便于团队复核）
# 入口/Ingress（若存在 ALB → Ingress NGINX 链路）
kubectl get ingress -A -o wide
kubectl describe ingress -A | sed -n '1,300p'

# NLB 详情（确认选择器/注解）
kubectl -n morph get svc awf-spa-nlb -o yaml | egrep -i 'annotation|type:|selector|target|nodePort|externalTrafficPolicy'

# Service → Pod 绑定
for ns in landry morph moth; do
  kubectl get endpoints -n $ns -o wide | sed -n '1,200p'
done

# 从 Deployment 抽取 envFrom/ConfigMapRef/SecretRef（用于定位 DB/Redis/Kafka）
for ns in landry morph moth; do
  kubectl get deploy -n $ns -o yaml | egrep -n "envFrom|configMapRef|secretRef|name:|containerPort" | sed -n '1,400p'
done

8) 说明

集群内未安装 apisixroutes CRD（来自你的命令行反馈），因此 APISIX 路由多半通过 Admin API 或外部配置管理；第 2 节映射基于现有文档/约定。

若需把**每条“域名/路径 → Service → Pod → DB/Redis/Kafka/Etcd”**链路做成逐项落表，请补充 APISIX Admin 导出（routes/services/upstreams），我将据此补齐“来源与证据”列。
